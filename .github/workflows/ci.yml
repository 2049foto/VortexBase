name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.10.0'
  BUN_VERSION: '1.1.0'

jobs:
  # ============================================
  # LINT & TYPE CHECK
  # ============================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Lint
        run: bun run lint

      - name: Type check
        run: bun run type-check

      - name: Format check
        run: bun run format:check

  # ============================================
  # UNIT TESTS
  # ============================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run tests
        run: bun run test:coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false

  # ============================================
  # BUILD
  # ============================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint
    env:
      # Minimal env vars for build
      NEXT_PUBLIC_APP_NAME: Vortex Protocol
      NEXT_PUBLIC_APP_URL: https://vortexbase.vercel.app
      NEXT_PUBLIC_CHAIN_ID: '8453'
      NEXT_PUBLIC_ADMIN_WALLET: '0xAdFB2776EB40e5218784386aa576ca9E08450127'
      NEXT_PUBLIC_WALLET_CONNECT_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_WALLET_CONNECT_PROJECT_ID }}
      NEXT_PUBLIC_PRIVY_APP_ID: ${{ secrets.NEXT_PUBLIC_PRIVY_APP_ID }}
      NEXT_PUBLIC_QUICKNODE_BASE_HTTPS: https://mainnet.base.org
      NEXT_PUBLIC_ALCHEMY_BASE_RPC: https://mainnet.base.org
      NEXT_PUBLIC_INFURA_BASE_HTTPS: https://mainnet.base.org
      NEXT_PUBLIC_ONCHAINKIT_API_KEY: ${{ secrets.NEXT_PUBLIC_ONCHAINKIT_API_KEY }}
      NEXT_PUBLIC_CDP_PAYMASTER_URL: https://api.developer.coinbase.com/rpc/v1/base
      NEXT_PUBLIC_PIMLICO_BASE_URL: https://api.pimlico.io/v2/8453/rpc
      NEXT_PUBLIC_ZERODEV_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_ZERODEV_PROJECT_ID }}
      NEXT_PUBLIC_GOPLUS_API_URL: https://api.gopluslabs.io/api/v1
      NEXT_PUBLIC_MORALIS_API_URL: https://deep-index.moralis.io/api/v2.2
      NEXT_PUBLIC_ONEINCH_API_URL: https://api.1inch.dev
      NEXT_PUBLIC_ZEROX_API_URL: https://api.0x.org
      NEXT_PUBLIC_DEXSCREENER_API_URL: https://api.dexscreener.com
      NEXT_PUBLIC_TURNSTILE_SITE_KEY: ${{ secrets.NEXT_PUBLIC_TURNSTILE_SITE_KEY }}
      NEXT_PUBLIC_POSTHOG_KEY: ${{ secrets.NEXT_PUBLIC_POSTHOG_KEY }}
      NEXT_PUBLIC_POSTHOG_HOST: https://us.i.posthog.com
      NEXT_PUBLIC_ENABLE_ANALYTICS: 'true'
      NEXT_PUBLIC_ENABLE_GASLESS: 'true'
      NEXT_PUBLIC_ENABLE_AI_CLASSIFICATION: 'true'
      NEXT_PUBLIC_ENABLE_VOLATILITY_DETECTOR: 'true'
      NEXT_PUBLIC_PROTOCOL_FEE_PERCENT: '0.8'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: .next
          retention-days: 7

  # ============================================
  # E2E TESTS (on main only)
  # ============================================
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build
          path: .next

      - name: Run E2E tests
        run: bun run test:e2e
        env:
          CI: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report
          retention-days: 30

  # ============================================
  # SECURITY AUDIT
  # ============================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Audit dependencies
        run: bun audit || true

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
